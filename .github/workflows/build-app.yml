name: Build & Deploy App

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '30 0 * * *' # 6:00 AM IST (00:30 UTC)
  workflow_dispatch:

env:
  APP_NAME: InvestIQ
  APP_VERSION: ${{ github.run_number }}
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  generate-data:
    name: Generate Market Data
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'scripts/requirements.txt'
    
    - name: Install Python dependencies
      working-directory: scripts
      run: pip install -r requirements.txt
    
    - name: Generate market data
      working-directory: scripts
      env:
        TIMESTAMP: ${{ github.event.head_commit.timestamp }}
      run: |
        echo "Generating market data..."
        python main.py
        echo "Data generation complete!"
    
    - name: Verify generated data
      run: |
        if [ ! -f "app/public/latest_data.json" ]; then
          echo "Error: latest_data.json not generated"
          exit 1
        fi
        FILE_SIZE=$(stat -f%z "app/public/latest_data.json" 2>/dev/null || stat -c%s "app/public/latest_data.json")
        echo "Generated data file size: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 1000 ]; then
          echo "Warning: Data file seems too small"
        fi
    
    - name: Upload generated data
      uses: actions/upload-artifact@v4
      with:
        name: market-data-${{ env.APP_VERSION }}
        path: app/public/latest_data.json
        retention-days: 7

  build-web:
    name: Build Web App
    needs: generate-data
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download market data
      uses: actions/download-artifact@v4
      with:
        name: market-data-${{ env.APP_VERSION }}
        path: app/public
    
    - name: Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: app/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Install dependencies
      working-directory: app
      run: npm ci --prefer-offline --no-audit --legacy-peer-deps
    
    - name: Lint code
      working-directory: app
      run: npm run lint
      continue-on-error: true
    
    - name: Build web app
      working-directory: app
      run: |
        echo "Building web app..."
        npm run build
        echo "Build complete!"
    
    - name: Upload web build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Web-v${{ env.APP_VERSION }}
        path: app/dist
        retention-days: 30
    
    - name: Cache build output for mobile
      uses: actions/cache@v4
      with:
        path: app/dist
        key: web-build-${{ github.sha }}

  build-android:
    name: Build Android APK
    needs: build-web
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download market data
      uses: actions/download-artifact@v4
      with:
        name: market-data-${{ env.APP_VERSION }}
        path: app/public
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'
    
    - name: Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: app/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Restore web build
      uses: actions/cache@v4
      with:
        path: app/dist
        key: web-build-${{ github.sha }}
    
    - name: Install dependencies
      working-directory: app
      run: npm ci --prefer-offline --no-audit --legacy-peer-deps
    
    - name: Build web (if not cached) & sync to Android
      working-directory: app
      run: |
        if [ ! -d "dist" ]; then
          echo "Building web app..."
          npm run build
        fi
        npx cap sync android
    
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          app/android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      working-directory: app/android
      run: chmod +x gradlew
    
    - name: Build APK (Debug)
      working-directory: app/android
      run: |
        echo "Building Android APK..."
        ./gradlew assembleDebug --no-daemon --stacktrace --build-cache --parallel
        echo "APK build complete!"
    
    - name: Rename & prepare APK
      run: |
        APK_PATH="app/android/app/build/outputs/apk/debug/app-debug.apk"
        NEW_NAME="${{ env.APP_NAME }}-Android-v${{ env.APP_VERSION }}-debug.apk"
        mv "$APK_PATH" "app/android/app/build/outputs/apk/debug/$NEW_NAME"
        echo "APK renamed to: $NEW_NAME"
    
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Android-v${{ env.APP_VERSION }}
        path: app/android/app/build/outputs/apk/debug/${{ env.APP_NAME }}-Android-v${{ env.APP_VERSION }}-debug.apk
        retention-days: 30

  build-ios:
    name: Build iOS App
    needs: build-web
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download market data
      uses: actions/download-artifact@v4
      with:
        name: market-data-${{ env.APP_VERSION }}
        path: app/public
    
    - name: Setup Node.js with cache
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/package-lock.json
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: app/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('app/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: Restore web build
      uses: actions/cache@v4
      with:
        path: app/dist
        key: web-build-${{ github.sha }}
    
    - name: Install dependencies
      working-directory: app
      run: npm ci --prefer-offline --no-audit --legacy-peer-deps
    
    - name: Build web (if not cached) & sync to iOS
      working-directory: app
      run: |
        if [ ! -d "dist" ]; then
          echo "Building web app..."
          npm run build
        fi
        npx cap sync ios
    
    - name: Cache CocoaPods
      uses: actions/cache@v4
      with:
        path: app/ios/App/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('app/ios/App/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
    
    - name: Build iOS (Unsigned)
      working-directory: app/ios/App
      run: |
        echo "Building iOS app (unsigned)..."
        xcodebuild clean build \
          -workspace App.xcworkspace \
          -scheme App \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -quiet
        echo "iOS build complete!"
    
    - name: Archive iOS build
      run: |
        cd app/ios/App/build/Debug-iphonesimulator
        zip -r "${{ env.APP_NAME }}-iOS-v${{ env.APP_VERSION }}-simulator.zip" App.app
    
    - name: Upload iOS build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-iOS-v${{ env.APP_VERSION }}
        path: app/ios/App/build/Debug-iphonesimulator/${{ env.APP_NAME }}-iOS-v${{ env.APP_VERSION }}-simulator.zip
        retention-days: 30

  test-summary:
    name: Generate Test Summary
    needs: [build-web, build-android, build-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create job summary
      run: |
        echo "# Build Summary - v${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Web Build: ${{ needs.build-web.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Android Build: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- iOS Build: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **Web**: ${{ env.APP_NAME }}-Web-v${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Android APK**: ${{ env.APP_NAME }}-Android-v${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **iOS Simulator**: ${{ env.APP_NAME }}-iOS-v${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Download" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts are available in the Actions tab for 30 days." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Performance Tips Applied" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Upgraded to latest action versions (v4/v5)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Aggressive caching (node_modules, Gradle, CocoaPods)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Build output reuse across jobs" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Parallel Gradle builds" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ No-audit npm installs" >> $GITHUB_STEP_SUMMARY
